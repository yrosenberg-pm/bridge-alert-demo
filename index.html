<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="hsl(222, 47%, 11%)">
    <title>Road Warrior - Bridge Alert</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: 'hsl(222, 47%, 11%)',
                        foreground: 'hsl(210, 40%, 98%)',
                        card: 'hsl(217, 33%, 17%)',
                        primary: 'hsl(217, 91%, 60%)',
                        muted: 'hsl(217, 19%, 27%)',
                        'muted-foreground': 'hsl(215, 20%, 65%)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: hsl(222, 47%, 11%);
            margin: 0;
            padding: 0;
            height: 100%;
        }
        body { 
            font-family: 'Inter', system-ui, sans-serif;
            color: hsl(210, 40%, 98%);
            -webkit-font-smoothing: antialiased;
        }
        .compass-tick {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen bg-background text-foreground overflow-x-hidden">
    <header class="fixed top-0 left-0 right-0 z-50 bg-background/80 backdrop-blur-md border-b border-white/5 px-4 flex items-center justify-between" style="padding-top: max(12px, env(safe-area-inset-top)); padding-bottom: 12px;">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-background" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            </div>
            <div>
                <h1 class="font-display font-bold text-lg leading-none">Road Warrior</h1>
                <div class="flex items-center gap-1.5 mt-0.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span class="text-[10px] font-mono uppercase text-muted-foreground tracking-wider">System Active v4.7</span>
                </div>
            </div>
        </div>
    </header>

    <main class="pt-20 px-3 max-w-sm mx-auto space-y-4 pb-8">
        <div class="bg-card/50 border border-white/5 backdrop-blur-sm rounded-xl p-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-primary/10 rounded-md text-primary">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                    </svg>
                </div>
                <div>
                    <div class="text-[10px] text-muted-foreground font-medium uppercase tracking-wider">Vehicle Height</div>
                    <div class="text-lg font-mono font-bold" id="vehicleHeight">15 ft</div>
                </div>
            </div>
            <button class="h-7 px-3 text-xs font-semibold border border-white/10 hover:bg-white/5 rounded-lg transition-colors" onclick="openEditModal()">Edit</button>
        </div>

        <div class="relative py-4">
            <div class="absolute top-0 right-0 text-right">
                <div class="text-[10px] text-muted-foreground uppercase tracking-widest mb-1">Bearing</div>
                <div class="text-base font-mono font-bold text-primary">
                    <span id="bearingValue">--</span>Â° <span class="text-xs text-muted-foreground" id="bearingDir">--</span>
                </div>
            </div>
            
            <div class="relative w-56 h-56 mx-auto flex items-center justify-center">
                <div class="absolute inset-0 rounded-full border-2 border-primary/20 bg-black/20 backdrop-blur-sm shadow-[inset_0_0_20px_rgba(0,0,0,0.5)]"></div>
                <div class="absolute inset-0" id="compassTicks"></div>
                
                <div class="absolute inset-0 w-full h-full transition-transform duration-300 ease-out" id="cardinalPoints">
                    <div class="absolute top-3 left-1/2 -translate-x-1/2 text-xs font-bold text-primary">N</div>
                    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 text-xs font-bold text-primary/50">S</div>
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-primary/50">W</div>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-bold text-primary/50">E</div>
                </div>

                <div class="absolute w-full h-full flex items-center justify-center transition-transform duration-300 ease-out" id="compassNeedle" style="display: none;">
                    <div class="relative h-full w-8 flex flex-col items-center justify-start py-8">
                        <div class="w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-b-[16px] border-b-primary" style="filter: drop-shadow(0 0 8px rgba(96, 165, 250, 0.8));"></div>
                    </div>
                </div>

                <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                    <div class="text-3xl font-mono font-bold text-white tracking-tighter drop-shadow-md">
                        <span id="distanceValue">--</span><span class="text-xs font-sans font-normal text-muted-foreground ml-1">mi</span>
                    </div>
                    <div class="text-[10px] text-primary/80 font-medium mt-1 tracking-widest uppercase">Distance</div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-4 opacity-70">
                <div>
                    <div class="text-[9px] text-muted-foreground uppercase tracking-widest mb-1">Latitude</div>
                    <div class="font-mono text-xs" id="latValue">---.------</div>
                </div>
                <div class="text-right">
                    <div class="text-[9px] text-muted-foreground uppercase tracking-widest mb-1">Longitude</div>
                    <div class="font-mono text-xs" id="lonValue">---.------</div>
                </div>
            </div>
        </div>

        <div id="alertPanel" class="rounded-xl border border-primary/30 bg-blue-500/10 p-4 backdrop-blur-md transition-all duration-500" style="display: none;">
            <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 rounded-full bg-background/20">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-base font-display font-bold uppercase tracking-wide text-primary" id="alertTitle">BRIDGE AHEAD</h3>
                        <p class="text-xs opacity-80 font-mono" id="bridgeName">Balboa Blvd over 101 Fwy</p>
                    </div>
                </div>
                <button class="px-3 py-1 text-[10px] font-semibold border border-white/10 hover:bg-white/5 rounded-full transition-colors" id="severityBadge">INFO</button>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-4">
                <div class="bg-background/20 rounded-lg p-2 text-center">
                    <div class="text-[10px] uppercase opacity-70 mb-1">Bridge</div>
                    <div class="text-xl font-bold font-mono text-primary" id="bridgeHeight">13.5'</div>
                </div>
                <div class="bg-background/20 rounded-lg p-2 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-red-500/20 animate-pulse" id="youHighlight" style="display: none;"></div>
                    <div class="text-[10px] uppercase opacity-70 mb-1 relative z-10">You</div>
                    <div class="text-xl font-bold font-mono relative z-10 text-primary" id="youHeight">15'</div>
                </div>
                <div class="bg-background/20 rounded-lg p-2 text-center">
                    <div class="text-[10px] uppercase opacity-70 mb-1">Clearance</div>
                    <div class="text-xl font-bold font-mono" id="clearanceValue">-1.5'</div>
                </div>
            </div>
        </div>

        <div class="flex justify-end">
            <button onclick="toggleTestMode()" id="testBtn" class="h-7 px-3 text-xs font-semibold border border-white/20 hover:bg-white/5 rounded-lg transition-colors">Test</button>
        </div>
    </main>

    <div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-card border border-white/10 rounded-2xl p-6 max-w-sm w-full">
            <h2 class="text-xl font-display font-bold mb-4">Vehicle Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-muted-foreground mb-2 block">Height (feet)</label>
                    <input type="number" id="heightInput" step="0.5" min="10" max="16" value="15" class="w-full bg-muted border border-white/10 rounded-lg px-4 py-2 text-lg font-mono focus:outline-none focus:border-primary">
                </div>
                <div class="flex gap-3">
                    <button onclick="closeEditModal()" class="flex-1 h-10 bg-muted hover:bg-muted/80 rounded-lg font-semibold transition-colors">Cancel</button>
                    <button onclick="saveHeight()" class="flex-1 h-10 bg-primary text-background hover:bg-primary/90 rounded-lg font-semibold transition-colors">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const state = {
            vehicleHeight: 15,
            watchId: null,
            isMonitoring: false,
            currentPosition: null,
            currentHeading: null,
            previousPosition: null,
            headingHistory: [],
            positionHistory: [],
            deviceHeading: null,
            nearestBridge: null,
            inTestMode: false,
            testScenario: 0,
            lastCheckTime: 0
        };
        
        const CONFIG = {
            HEADING_HISTORY_SIZE: 15,
            POSITION_HISTORY_SIZE: 5,
            CHECK_THROTTLE: 2000,
            MIN_SPEED_MPH: 5,
            MAX_ALERT_DISTANCE: 2.0,
            MIN_HEADING_SAMPLES: 3,
            MIN_HEADING_SAMPLES_SLOW: 5,
            APPROACH_ANGLE: 90
        };

        const BRIDGES = [
            { id: 'EN-101-BALBOA', name: 'Balboa Blvd over 101 Fwy', lat: 34.17046697384523, lon: -118.50114573681475, clearance: 13.5, type: 'underpass' },
            { id: 'SO-405-BURBANK', name: 'Burbank Blvd over 405 Fwy', lat: 34.172153559602314, lon: -118.46768567630716, clearance: 13.0, type: 'underpass' },
            { id: 'SC-101-COLDWATER', name: 'Coldwater Canyon over 101 Fwy', lat: 34.15674619828743, lon: -118.41376835430795, clearance: 13.0, type: 'underpass' }
        ];

        const els = {};
        
        function initElements() {
            const ids = ['compassTicks', 'cardinalPoints', 'compassNeedle', 'bearingValue', 'bearingDir', 
                         'distanceValue', 'latValue', 'lonValue', 'alertPanel', 'alertTitle', 'bridgeName', 
                         'bridgeHeight', 'youHeight', 'clearanceValue', 'youHighlight', 'vehicleHeight', 
                         'severityBadge', 'editModal', 'heightInput', 'testBtn'];
            ids.forEach(id => els[id] = document.getElementById(id));
        }

        function initCompass() {
            [0, 45, 90, 135, 180, 225, 270, 315].forEach(deg => {
                const tick = document.createElement('div');
                tick.className = 'compass-tick';
                tick.style.transform = `rotate(${deg}deg)`;
                tick.innerHTML = '<div class="mx-auto w-0.5 h-3 bg-primary/40 mt-1"></div>';
                els.compassTicks.appendChild(tick);
            });
        }

        function getCardinalDirection(bearing) {
            const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            return dirs[Math.round(((bearing % 360) / 45)) % 8];
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + 
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) - 
                     Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        function getSmoothedHeading() {
            if (!state.headingHistory.length) return null;
            let sumX = 0, sumY = 0, totalWeight = 0;
            for (let i = 0; i < state.headingHistory.length; i++) {
                const weight = Math.pow(2, i);
                const rad = state.headingHistory[i] * Math.PI / 180;
                sumX += Math.cos(rad) * weight;
                sumY += Math.sin(rad) * weight;
                totalWeight += weight;
            }
            return (Math.atan2(sumY / totalWeight, sumX / totalWeight) * 180 / Math.PI + 360) % 360;
        }

        function getSeverityConfig(distance) {
            if (distance <= 0.5) {
                return {
                    severity: 'critical',
                    panelClass: 'rounded-xl border-2 border-red-500/50 bg-red-600/20 p-4 backdrop-blur-md transition-all duration-500 animate-pulse',
                    titleColor: 'text-red-500',
                    titleText: 'CRITICAL ALERT',
                    badgeText: 'CRITICAL',
                    badgeClass: 'px-3 py-1 text-[10px] font-semibold rounded-full transition-colors border-red-500/70 text-red-500 bg-red-500/20'
                };
            } else if (distance <= 1.0) {
                return {
                    severity: 'warning',
                    panelClass: 'rounded-xl border border-orange-600/50 bg-orange-600/20 p-4 backdrop-blur-md transition-all duration-500',
                    titleColor: 'text-orange-500',
                    titleText: 'WARNING',
                    badgeText: 'WARNING',
                    badgeClass: 'px-3 py-1 text-[10px] font-semibold rounded-full transition-colors border-orange-500/70 text-orange-500 bg-orange-500/20'
                };
            } else {
                return {
                    severity: 'caution',
                    panelClass: 'rounded-xl border border-yellow-500/40 bg-yellow-500/15 p-4 backdrop-blur-md transition-all duration-500',
                    titleColor: 'text-yellow-400',
                    titleText: 'CAUTION',
                    badgeText: 'CAUTION',
                    badgeClass: 'px-3 py-1 text-[10px] font-semibold rounded-full transition-colors border-yellow-500/70 text-yellow-400 bg-yellow-500/20'
                };
            }
        }

        function updateCompass() {
            const displayHeading = state.deviceHeading !== null ? state.deviceHeading : (state.currentHeading || 0);
            els.cardinalPoints.style.transform = `rotate(${-displayHeading}deg)`;
            
            if (state.nearestBridge) {
                const relativeBearing = state.nearestBridge.bearing - displayHeading;
                els.compassNeedle.style.display = 'flex';
                els.compassNeedle.style.transform = `rotate(${relativeBearing}deg)`;
                
                els.bearingValue.textContent = state.nearestBridge.bearing;
                els.bearingDir.textContent = getCardinalDirection(state.nearestBridge.bearing);
                els.distanceValue.textContent = state.nearestBridge.distance.toFixed(1);
            } else {
                els.compassNeedle.style.display = 'none';
                if (state.currentHeading !== null) {
                    els.bearingValue.textContent = Math.round(state.currentHeading);
                    els.bearingDir.textContent = getCardinalDirection(state.currentHeading);
                }
                els.distanceValue.textContent = '--';
            }
        }

        function updateAlertPanel() {
            if (state.nearestBridge && !state.nearestBridge.hideAlert && state.vehicleHeight > state.nearestBridge.bridge.clearance) {
                els.alertPanel.style.display = 'block';
                
                const config = getSeverityConfig(state.nearestBridge.distance);
                
                els.alertPanel.className = config.panelClass;
                els.alertTitle.textContent = config.titleText;
                els.alertTitle.className = `text-base font-display font-bold uppercase tracking-wide ${config.titleColor}`;
                els.severityBadge.textContent = config.badgeText;
                els.severityBadge.className = config.badgeClass;
                
                els.bridgeName.textContent = state.nearestBridge.bridge.name;
                els.bridgeHeight.textContent = `${state.nearestBridge.bridge.clearance}'`;
                els.youHeight.textContent = `${state.vehicleHeight.toFixed(1)}'`;
                
                const clearance = state.nearestBridge.bridge.clearance - state.vehicleHeight;
                els.clearanceValue.textContent = `${clearance.toFixed(1)}'`;
                els.clearanceValue.className = `text-xl font-bold font-mono ${clearance < 0 ? 'text-red-500' : 'text-emerald-500'}`;
                els.youHighlight.style.display = clearance < 0 ? 'block' : 'none';
                
            } else {
                els.alertPanel.style.display = 'none';
            }
        }

        function checkAlerts() {
            if (!state.currentPosition || state.inTestMode) return;
            
            const { latitude, longitude } = state.currentPosition;
            const speedMph = (state.currentPosition.speed || 0) * 2.23694;
            const isMoving = speedMph >= CONFIG.MIN_SPEED_MPH;
            
            let closestBridge = null;
            let closestDistance = Infinity;

            for (const bridge of BRIDGES) {
                if (bridge.type !== 'underpass') continue;
                
                const distance = calculateDistance(latitude, longitude, bridge.lat, bridge.lon);
                const bearing = calculateBearing(latitude, longitude, bridge.lat, bridge.lon);
                
                if (distance < closestDistance && distance <= CONFIG.MAX_ALERT_DISTANCE) {
                    closestDistance = distance;
                    closestBridge = { bridge, distance, bearing: Math.round(bearing) };
                }
            }

            state.nearestBridge = closestBridge;
            
            if (closestBridge) {
                let shouldHideAlert = false;
                
                const hasHeading = state.currentHeading !== null || state.deviceHeading !== null;
                const effectiveHeading = state.currentHeading || state.deviceHeading || 0;
                
                const headingSampleCount = state.headingHistory.length;
                const positionSampleCount = state.positionHistory.length;
                
                if (isMoving && headingSampleCount >= CONFIG.MIN_HEADING_SAMPLES) {
                    const bearingDiff = Math.abs((closestBridge.bearing - effectiveHeading + 540) % 360 - 180);
                    if (bearingDiff > CONFIG.APPROACH_ANGLE) {
                        shouldHideAlert = true;
                    }
                }
                else if (!isMoving && state.deviceHeading !== null) {
                    if (positionSampleCount < 2) {
                        shouldHideAlert = true;
                    } else {
                        const bearingDiff = Math.abs((closestBridge.bearing - state.deviceHeading + 540) % 360 - 180);
                        if (bearingDiff > CONFIG.APPROACH_ANGLE) {
                            shouldHideAlert = true;
                        }
                    }
                }
                else if (!isMoving && headingSampleCount >= CONFIG.MIN_HEADING_SAMPLES_SLOW) {
                    const bearingDiff = Math.abs((closestBridge.bearing - effectiveHeading + 540) % 360 - 180);
                    if (bearingDiff > CONFIG.APPROACH_ANGLE) {
                        shouldHideAlert = true;
                    }
                }
                else {
                    shouldHideAlert = true;
                }
                
                if (closestBridge.distance <= 0.3 && state.vehicleHeight > closestBridge.bridge.clearance) {
                    shouldHideAlert = false;
                }
                
                if (shouldHideAlert) {
                    state.nearestBridge = { ...closestBridge, hideAlert: true };
                }
            }
            
            updateCompass();
            updateAlertPanel();
        }

        function onDeviceOrientation(e) {
            let h = null;
            if (e.webkitCompassHeading !== undefined) h = e.webkitCompassHeading;
            else if (e.alpha !== null) h = (360 - e.alpha) % 360;
            if (h !== null) {
                state.deviceHeading = h;
                updateCompass();
            }
        }

        function onPositionUpdate(pos) {
            state.previousPosition = state.currentPosition;
            state.currentPosition = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
                speed: pos.coords.speed || 0,
                timestamp: Date.now()
            };

            state.positionHistory.push({ 
                lat: state.currentPosition.latitude, 
                lon: state.currentPosition.longitude, 
                timestamp: state.currentPosition.timestamp 
            });
            if (state.positionHistory.length > CONFIG.POSITION_HISTORY_SIZE) state.positionHistory.shift();

            let newHeading = null;
            const speedMph = (pos.coords.speed || 0) * 2.23694;
            
            if (pos.coords.heading !== null && pos.coords.heading !== undefined && speedMph >= CONFIG.MIN_SPEED_MPH) {
                newHeading = pos.coords.heading;
            } else if (state.previousPosition && speedMph >= CONFIG.MIN_SPEED_MPH) {
                newHeading = calculateBearing(
                    state.previousPosition.latitude, 
                    state.previousPosition.longitude, 
                    state.currentPosition.latitude, 
                    state.currentPosition.longitude
                );
            }

            if (newHeading !== null) {
                state.headingHistory.push(newHeading);
                if (state.headingHistory.length > CONFIG.HEADING_HISTORY_SIZE) state.headingHistory.shift();
                state.currentHeading = getSmoothedHeading();
            }

            els.latValue.textContent = state.currentPosition.latitude.toFixed(6);
            els.lonValue.textContent = state.currentPosition.longitude.toFixed(6);

            const now = Date.now();
            if (now - state.lastCheckTime >= CONFIG.CHECK_THROTTLE) {
                checkAlerts();
                state.lastCheckTime = now;
            }
            
            updateCompass();
        }

        function startMonitoring() {
            if (!navigator.geolocation || state.inTestMode) return;
            
            state.watchId = navigator.geolocation.watchPosition(
                onPositionUpdate, 
                e => console.error('GPS Error:', e), 
                { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
            );
            
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', onDeviceOrientation);
            }
            
            state.isMonitoring = true;
        }

        function openEditModal() {
            els.editModal.classList.remove('hidden');
            els.editModal.classList.add('flex');
            els.heightInput.value = state.vehicleHeight;
        }

        function closeEditModal() {
            els.editModal.classList.add('hidden');
            els.editModal.classList.remove('flex');
        }

        function saveHeight() {
            state.vehicleHeight = parseFloat(els.heightInput.value);
            els.vehicleHeight.textContent = `${state.vehicleHeight.toFixed(1)} ft`;
            els.youHeight.textContent = `${state.vehicleHeight.toFixed(1)}'`;
            updateAlertPanel();
            closeEditModal();
        }

        function toggleTestMode() {
            if (!state.inTestMode) {
                state.inTestMode = true;
                state.testScenario = 0;
                els.testBtn.textContent = 'Next';
                els.testBtn.classList.add('bg-primary', 'text-background', 'border-primary');
                els.testBtn.classList.remove('border-white/20', 'hover:bg-white/5');
                runTestScenario();
            } else {
                state.testScenario++;
                if (state.testScenario > 2) {
                    exitTestMode();
                } else {
                    runTestScenario();
                }
            }
        }

        function runTestScenario() {
            state.currentHeading = 45;
            state.headingHistory = Array(5).fill(45);
            state.positionHistory = [
                { lat: 34.17046697384523 - 0.006, lon: -118.50114573681475, timestamp: Date.now() - 2000 },
                { lat: 34.17046697384523 - 0.0055, lon: -118.50114573681475, timestamp: Date.now() - 1000 },
                { lat: 34.17046697384523 - 0.005, lon: -118.50114573681475, timestamp: Date.now() }
            ];
            
            const scenarios = [
                { height: 15.0, latOffset: -0.005, distance: 0.3 },
                { height: 14.5, latOffset: -0.012, distance: 0.8 },
                { height: 14.0, latOffset: -0.022, distance: 1.5 }
            ];
            
            const scenario = scenarios[state.testScenario];
            state.vehicleHeight = scenario.height;
            state.currentPosition = {
                latitude: BRIDGES[0].lat + scenario.latOffset,
                longitude: BRIDGES[0].lon,
                speed: 13.41,
                timestamp: Date.now()
            };
            
            state.nearestBridge = {
                bridge: BRIDGES[0],
                distance: scenario.distance,
                bearing: 45
            };
            
            els.vehicleHeight.textContent = `${state.vehicleHeight.toFixed(1)} ft`;
            els.youHeight.textContent = `${state.vehicleHeight.toFixed(1)}'`;
            els.latValue.textContent = state.currentPosition.latitude.toFixed(6);
            els.lonValue.textContent = state.currentPosition.longitude.toFixed(6);
            
            updateCompass();
            updateAlertPanel();
        }

        function exitTestMode() {
            state.inTestMode = false;
            state.testScenario = 0;
            
            els.testBtn.textContent = 'Test';
            els.testBtn.classList.remove('bg-primary', 'text-background', 'border-primary');
            els.testBtn.classList.add('border-white/20', 'hover:bg-white/5');
            
            state.vehicleHeight = 15.0;
            state.nearestBridge = null;
            state.currentPosition = null;
            state.currentHeading = null;
            state.headingHistory = [];
            state.positionHistory = [];
            
            els.vehicleHeight.textContent = `${state.vehicleHeight.toFixed(1)} ft`;
            els.latValue.textContent = '---.------';
            els.lonValue.textContent = '---.------';
            els.bearingValue.textContent = '--';
            els.bearingDir.textContent = '--';
            els.distanceValue.textContent = '--';
            
            updateCompass();
            updateAlertPanel();
            startMonitoring();
        }

        window.addEventListener('load', () => {
            initElements();
            initCompass();
            if (!state.inTestMode) startMonitoring();
        });
    </script>
</body>
</html>
