<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="hsl(222, 47%, 11%)">
    <title>Road Warrior - Bridge Alert</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: 'hsl(222, 47%, 11%)',
                        foreground: 'hsl(210, 40%, 98%)',
                        card: 'hsl(217, 33%, 17%)',
                        primary: 'hsl(217, 91%, 60%)',
                        muted: 'hsl(217, 19%, 27%)',
                        'muted-foreground': 'hsl(215, 20%, 65%)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { background: hsl(222, 47%, 11%); margin: 0; padding: 0; height: 100%; }
        body { font-family: 'Inter', system-ui, sans-serif; color: hsl(210, 40%, 98%); -webkit-font-smoothing: antialiased; }
        .compass-tick { position: absolute; width: 100%; height: 100%; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen bg-background text-foreground overflow-x-hidden">
    <header class="fixed top-0 left-0 right-0 z-50 bg-background/80 backdrop-blur-md border-b border-white/5 px-4 flex items-center justify-between" style="padding-top: max(12px, env(safe-area-inset-top)); padding-bottom: 12px;">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-background" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            </div>
            <div>
                <h1 class="font-display font-bold text-lg leading-none">Road Warrior</h1>
                <div class="flex items-center gap-1.5 mt-0.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span class="text-[10px] font-mono uppercase text-muted-foreground tracking-wider">System Active v4.9</span>
                </div>
            </div>
        </div>
    </header>

    <main class="px-3 max-w-sm mx-auto space-y-4 pb-8" style="padding-top: max(80px, calc(env(safe-area-inset-top) + 80px));">
        <!-- Vehicle Height Card -->
        <div class="bg-card/50 border border-white/5 backdrop-blur-sm rounded-xl p-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="p-2 bg-primary/10 rounded-md text-primary">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                    </svg>
                </div>
                <div>
                    <div class="text-[10px] text-muted-foreground font-medium uppercase tracking-wider">Vehicle Height</div>
                    <div class="text-lg font-mono font-bold" id="vehicleHeight">15 ft</div>
                </div>
            </div>
            <button class="h-7 px-3 text-xs font-semibold border border-white/10 hover:bg-white/5 rounded-lg transition-colors" onclick="UI.openEditModal()">Edit</button>
        </div>

        <!-- Compass Section -->
        <div class="relative py-4">
            <div class="absolute top-0 right-0 text-right">
                <div class="text-[10px] text-muted-foreground uppercase tracking-widest mb-1">Bearing</div>
                <div class="text-base font-mono font-bold text-primary">
                    <span id="bearingValue">--</span>° <span class="text-xs text-muted-foreground" id="bearingDir">--</span>
                </div>
            </div>
            
            <div class="relative w-56 h-56 mx-auto flex items-center justify-center">
                <div class="absolute inset-0 rounded-full border-2 border-primary/20 bg-black/20 backdrop-blur-sm shadow-[inset_0_0_20px_rgba(0,0,0,0.5)]"></div>
                <div class="absolute inset-0" id="compassTicks"></div>
                
                <div class="absolute inset-0 w-full h-full transition-transform duration-300 ease-out" id="cardinalPoints">
                    <div class="absolute top-3 left-1/2 -translate-x-1/2 text-xs font-bold text-primary">N</div>
                    <div class="absolute bottom-3 left-1/2 -translate-x-1/2 text-xs font-bold text-primary/50">S</div>
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-xs font-bold text-primary/50">W</div>
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-xs font-bold text-primary/50">E</div>
                </div>

                <div class="absolute w-full h-full flex items-center justify-center transition-transform duration-300 ease-out" id="compassNeedle" style="display: none;">
                    <div class="relative h-full w-8 flex flex-col items-center justify-start py-8">
                        <div class="w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-b-[16px] border-b-primary" style="filter: drop-shadow(0 0 8px rgba(96, 165, 250, 0.8));"></div>
                    </div>
                </div>

                <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                    <div class="text-3xl font-mono font-bold text-white tracking-tighter drop-shadow-md">
                        <span id="distanceValue">--</span><span class="text-xs font-sans font-normal text-muted-foreground ml-1">mi</span>
                    </div>
                    <div class="text-[10px] text-primary/80 font-medium mt-1 tracking-widest uppercase">Distance</div>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-4 opacity-70">
                <div>
                    <div class="text-[9px] text-muted-foreground uppercase tracking-widest mb-1">Latitude</div>
                    <div class="font-mono text-xs" id="latValue">---.------</div>
                </div>
                <div class="text-right">
                    <div class="text-[9px] text-muted-foreground uppercase tracking-widest mb-1">Longitude</div>
                    <div class="font-mono text-xs" id="lonValue">---.------</div>
                </div>
            </div>
        </div>

        <!-- Alert Panel -->
        <div id="alertPanel" class="rounded-xl border border-primary/30 bg-blue-500/10 p-4 backdrop-blur-md transition-all duration-500" style="display: none;">
            <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 rounded-full bg-background/20">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-base font-display font-bold uppercase tracking-wide text-primary" id="alertTitle">BRIDGE AHEAD</h3>
                        <p class="text-xs opacity-80 font-mono" id="bridgeName">Balboa Blvd over 101 Fwy</p>
                    </div>
                </div>
                <button class="px-3 py-1 text-[10px] font-semibold border border-white/10 hover:bg-white/5 rounded-full transition-colors" id="severityBadge">INFO</button>
            </div>
            <div class="grid grid-cols-3 gap-2 mt-4">
                <div class="bg-background/20 rounded-lg p-2 text-center">
                    <div class="text-[10px] uppercase opacity-70 mb-1">Bridge</div>
                    <div class="text-xl font-bold font-mono text-primary" id="bridgeHeight">13.5'</div>
                </div>
                <div class="bg-background/20 rounded-lg p-2 text-center relative overflow-hidden">
                    <div class="absolute inset-0 bg-red-500/20 animate-pulse" id="youHighlight" style="display: none;"></div>
                    <div class="text-[10px] uppercase opacity-70 mb-1 relative z-10">You</div>
                    <div class="text-xl font-bold font-mono relative z-10 text-primary" id="youHeight">15'</div>
                </div>
                <div class="bg-background/20 rounded-lg p-2 text-center">
                    <div class="text-[10px] uppercase opacity-70 mb-1">Clearance</div>
                    <div class="text-xl font-bold font-mono" id="clearanceValue">-1.5'</div>
                </div>
            </div>
        </div>

        <div class="flex justify-end">
            <button onclick="Test.toggle()" id="testBtn" class="h-7 px-3 text-xs font-semibold border border-white/20 hover:bg-white/5 rounded-lg transition-colors">Test</button>
        </div>
    </main>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-card border border-white/10 rounded-2xl p-6 max-w-sm w-full">
            <h2 class="text-xl font-display font-bold mb-4">Vehicle Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-muted-foreground mb-2 block">Height (feet)</label>
                    <input type="number" id="heightInput" step="0.5" min="10" max="16" value="15" class="w-full bg-muted border border-white/10 rounded-lg px-4 py-2 text-lg font-mono focus:outline-none focus:border-primary">
                </div>
                <div class="flex gap-3">
                    <button onclick="UI.closeEditModal()" class="flex-1 h-10 bg-muted hover:bg-muted/80 rounded-lg font-semibold transition-colors">Cancel</button>
                    <button onclick="UI.saveHeight()" class="flex-1 h-10 bg-primary text-background hover:bg-primary/90 rounded-lg font-semibold transition-colors">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    /* ═══════════════════════════════════════════════════════════════════════════
       ROAD WARRIOR v4.9 - Bridge Clearance Alert System
       Optimized for maintainability and future development
       ═══════════════════════════════════════════════════════════════════════════ */

    // ─────────────────────────────────────────────────────────────────────────────
    // CONFIGURATION - Tune these values based on field testing
    // ─────────────────────────────────────────────────────────────────────────────
    const CONFIG = {
        // Heading stabilization
        HEADING_HISTORY_SIZE: 15,      // Samples for heading smoothing
        POSITION_HISTORY_SIZE: 5,      // Samples for position tracking
        
        // Alert timing
        CHECK_THROTTLE: 2000,          // ms between bridge checks
        
        // Movement detection
        MIN_SPEED_MPH: 5,              // Below this = stationary
        
        // Alert thresholds
        MAX_ALERT_DISTANCE: 2.0,       // Max miles to show bridge in compass
        CRITICAL_DISTANCE: 0.3,        // Force alert regardless of heading
        
        // Heading validation
        MIN_HEADING_SAMPLES: 3,        // Samples needed while moving
        MIN_HEADING_SAMPLES_SLOW: 5,   // Samples needed while stationary
        APPROACH_ANGLE: 90,            // Max degrees off-bearing to alert
        
        // Severity thresholds (miles)
        SEVERITY: {
            CRITICAL: 0.5,
            WARNING: 1.0
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // BRIDGE DATABASE - Add new bridges here
    // Format: { id, name, lat, lon, clearance (ft), type }
    // ─────────────────────────────────────────────────────────────────────────────
    const BRIDGES = [
        { id: 'EN-101-BALBOA', name: 'Balboa Blvd over 101 Fwy', lat: 34.17046697384523, lon: -118.50114573681475, clearance: 13.5, type: 'underpass' },
        { id: 'SO-405-BURBANK', name: 'Burbank Blvd over 405 Fwy', lat: 34.172153559602314, lon: -118.46768567630716, clearance: 13.0, type: 'underpass' },
        { id: 'SC-101-COLDWATER', name: 'Coldwater Canyon over 101 Fwy', lat: 34.15674619828743, lon: -118.41376835430795, clearance: 13.0, type: 'underpass' }
    ];

    // ─────────────────────────────────────────────────────────────────────────────
    // APPLICATION STATE
    // ─────────────────────────────────────────────────────────────────────────────
    const State = {
        vehicleHeight: 15,
        watchId: null,
        isMonitoring: false,
        currentPosition: null,
        previousPosition: null,
        currentHeading: null,
        deviceHeading: null,
        nearestBridge: null,
        headingHistory: [],
        positionHistory: [],
        lastCheckTime: 0,
        inTestMode: false,
        testScenario: 0
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // DOM ELEMENT CACHE
    // ─────────────────────────────────────────────────────────────────────────────
    const DOM = {};
    const DOM_IDS = [
        'compassTicks', 'cardinalPoints', 'compassNeedle', 'bearingValue', 'bearingDir',
        'distanceValue', 'latValue', 'lonValue', 'alertPanel', 'alertTitle', 'bridgeName',
        'bridgeHeight', 'youHeight', 'clearanceValue', 'youHighlight', 'vehicleHeight',
        'severityBadge', 'editModal', 'heightInput', 'testBtn'
    ];

    // ─────────────────────────────────────────────────────────────────────────────
    // GEO UTILITIES
    // ─────────────────────────────────────────────────────────────────────────────
    const Geo = {
        EARTH_RADIUS_MI: 3959,
        DEG_TO_RAD: Math.PI / 180,
        RAD_TO_DEG: 180 / Math.PI,
        
        /** Calculate distance between two points in miles */
        distance(lat1, lon1, lat2, lon2) {
            const dLat = (lat2 - lat1) * this.DEG_TO_RAD;
            const dLon = (lon2 - lon1) * this.DEG_TO_RAD;
            const a = Math.sin(dLat/2) ** 2 + 
                     Math.cos(lat1 * this.DEG_TO_RAD) * Math.cos(lat2 * this.DEG_TO_RAD) * 
                     Math.sin(dLon/2) ** 2;
            return this.EARTH_RADIUS_MI * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        },
        
        /** Calculate bearing from point 1 to point 2 in degrees */
        bearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * this.DEG_TO_RAD;
            const y = Math.sin(dLon) * Math.cos(lat2 * this.DEG_TO_RAD);
            const x = Math.cos(lat1 * this.DEG_TO_RAD) * Math.sin(lat2 * this.DEG_TO_RAD) - 
                     Math.sin(lat1 * this.DEG_TO_RAD) * Math.cos(lat2 * this.DEG_TO_RAD) * Math.cos(dLon);
            return (Math.atan2(y, x) * this.RAD_TO_DEG + 360) % 360;
        },
        
        /** Get cardinal direction from bearing */
        cardinalDir(bearing) {
            const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            return dirs[Math.round(((bearing % 360) / 45)) % 8];
        },
        
        /** Calculate angular difference between two bearings */
        bearingDiff(b1, b2) {
            return Math.abs((b1 - b2 + 540) % 360 - 180);
        },
        
        /** Convert m/s to mph */
        msToMph(ms) {
            return (ms || 0) * 2.23694;
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // HEADING PROCESSOR
    // ─────────────────────────────────────────────────────────────────────────────
    const Heading = {
        /** Add a heading sample and maintain history size */
        addSample(heading) {
            State.headingHistory.push(heading);
            if (State.headingHistory.length > CONFIG.HEADING_HISTORY_SIZE) {
                State.headingHistory.shift();
            }
            State.currentHeading = this.getSmoothed();
        },
        
        /** Get exponentially weighted smoothed heading */
        getSmoothed() {
            if (!State.headingHistory.length) return null;
            let sumX = 0, sumY = 0, totalWeight = 0;
            
            for (let i = 0; i < State.headingHistory.length; i++) {
                const weight = Math.pow(2, i);
                const rad = State.headingHistory[i] * Geo.DEG_TO_RAD;
                sumX += Math.cos(rad) * weight;
                sumY += Math.sin(rad) * weight;
                totalWeight += weight;
            }
            return (Math.atan2(sumY / totalWeight, sumX / totalWeight) * Geo.RAD_TO_DEG + 360) % 360;
        },
        
        /** Get effective heading (prefer device compass when stationary) */
        getEffective() {
            return State.currentHeading ?? State.deviceHeading ?? 0;
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // SEVERITY CONFIGURATION
    // ─────────────────────────────────────────────────────────────────────────────
    const Severity = {
        configs: {
            critical: {
                panelClass: 'rounded-xl border-2 border-red-500/50 bg-red-600/20 p-4 backdrop-blur-md transition-all duration-500 animate-pulse',
                titleColor: 'text-red-500',
                titleText: 'CRITICAL ALERT',
                badgeText: 'CRITICAL',
                badgeClass: 'px-3 py-1 text-[10px] font-semibold rounded-full transition-colors border-red-500/70 text-red-500 bg-red-500/20'
            },
            warning: {
                panelClass: 'rounded-xl border border-orange-600/50 bg-orange-600/20 p-4 backdrop-blur-md transition-all duration-500',
                titleColor: 'text-orange-500',
                titleText: 'WARNING',
                badgeText: 'WARNING',
                badgeClass: 'px-3 py-1 text-[10px] font-semibold rounded-full transition-colors border-orange-500/70 text-orange-500 bg-orange-500/20'
            },
            caution: {
                panelClass: 'rounded-xl border border-yellow-500/40 bg-yellow-500/15 p-4 backdrop-blur-md transition-all duration-500',
                titleColor: 'text-yellow-400',
                titleText: 'CAUTION',
                badgeText: 'CAUTION',
                badgeClass: 'px-3 py-1 text-[10px] font-semibold rounded-full transition-colors border-yellow-500/70 text-yellow-400 bg-yellow-500/20'
            }
        },
        
        getForDistance(distance) {
            if (distance <= CONFIG.SEVERITY.CRITICAL) return this.configs.critical;
            if (distance <= CONFIG.SEVERITY.WARNING) return this.configs.warning;
            return this.configs.caution;
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // BRIDGE DETECTION ENGINE
    // ─────────────────────────────────────────────────────────────────────────────
    const BridgeDetector = {
        /** Find nearest bridge within alert range */
        findNearest(lat, lon) {
            let closest = null;
            let minDist = Infinity;
            
            for (const bridge of BRIDGES) {
                if (bridge.type !== 'underpass') continue;
                
                const dist = Geo.distance(lat, lon, bridge.lat, bridge.lon);
                const bearing = Geo.bearing(lat, lon, bridge.lat, bridge.lon);
                
                if (dist < minDist && dist <= CONFIG.MAX_ALERT_DISTANCE) {
                    minDist = dist;
                    closest = { bridge, distance: dist, bearing: Math.round(bearing) };
                }
            }
            return closest;
        },
        
        /** Determine if alert should be hidden based on approach criteria */
        shouldHideAlert(bridgeData, speedMph) {
            const isMoving = speedMph >= CONFIG.MIN_SPEED_MPH;
            const headingSamples = State.headingHistory.length;
            const positionSamples = State.positionHistory.length;
            const effectiveHeading = Heading.getEffective();
            
            // Force alert if very close and vehicle won't fit
            if (bridgeData.distance <= CONFIG.CRITICAL_DISTANCE && 
                State.vehicleHeight > bridgeData.bridge.clearance) {
                return false;
            }
            
            // Moving with enough heading data
            if (isMoving && headingSamples >= CONFIG.MIN_HEADING_SAMPLES) {
                return Geo.bearingDiff(bridgeData.bearing, effectiveHeading) > CONFIG.APPROACH_ANGLE;
            }
            
            // Stationary with device compass
            if (!isMoving && State.deviceHeading !== null) {
                if (positionSamples < 2) return true;
                return Geo.bearingDiff(bridgeData.bearing, State.deviceHeading) > CONFIG.APPROACH_ANGLE;
            }
            
            // Stationary with GPS heading history
            if (!isMoving && headingSamples >= CONFIG.MIN_HEADING_SAMPLES_SLOW) {
                return Geo.bearingDiff(bridgeData.bearing, effectiveHeading) > CONFIG.APPROACH_ANGLE;
            }
            
            // Not enough data - hide alert
            return true;
        },
        
        /** Main check routine */
        check() {
            if (!State.currentPosition || State.inTestMode) return;
            
            const { latitude, longitude, speed } = State.currentPosition;
            const speedMph = Geo.msToMph(speed);
            
            const nearest = this.findNearest(latitude, longitude);
            
            if (nearest) {
                const hideAlert = this.shouldHideAlert(nearest, speedMph);
                State.nearestBridge = hideAlert ? { ...nearest, hideAlert: true } : nearest;
            } else {
                State.nearestBridge = null;
            }
            
            Compass.update();
            AlertPanel.update();
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // COMPASS DISPLAY
    // ─────────────────────────────────────────────────────────────────────────────
    const Compass = {
        init() {
            [0, 45, 90, 135, 180, 225, 270, 315].forEach(deg => {
                const tick = document.createElement('div');
                tick.className = 'compass-tick';
                tick.style.transform = `rotate(${deg}deg)`;
                tick.innerHTML = '<div class="mx-auto w-0.5 h-3 bg-primary/40 mt-1"></div>';
                DOM.compassTicks.appendChild(tick);
            });
        },
        
        update() {
            const displayHeading = State.deviceHeading ?? State.currentHeading ?? 0;
            DOM.cardinalPoints.style.transform = `rotate(${-displayHeading}deg)`;
            
            if (State.nearestBridge) {
                const relative = State.nearestBridge.bearing - displayHeading;
                DOM.compassNeedle.style.display = 'flex';
                DOM.compassNeedle.style.transform = `rotate(${relative}deg)`;
                DOM.bearingValue.textContent = State.nearestBridge.bearing;
                DOM.bearingDir.textContent = Geo.cardinalDir(State.nearestBridge.bearing);
                DOM.distanceValue.textContent = State.nearestBridge.distance.toFixed(1);
            } else {
                DOM.compassNeedle.style.display = 'none';
                if (State.currentHeading !== null) {
                    DOM.bearingValue.textContent = Math.round(State.currentHeading);
                    DOM.bearingDir.textContent = Geo.cardinalDir(State.currentHeading);
                }
                DOM.distanceValue.textContent = '--';
            }
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // ALERT PANEL
    // ─────────────────────────────────────────────────────────────────────────────
    const AlertPanel = {
        update() {
            const b = State.nearestBridge;
            const shouldShow = b && !b.hideAlert && State.vehicleHeight > b.bridge.clearance;
            
            if (!shouldShow) {
                DOM.alertPanel.style.display = 'none';
                return;
            }
            
            DOM.alertPanel.style.display = 'block';
            
            const cfg = Severity.getForDistance(b.distance);
            DOM.alertPanel.className = cfg.panelClass;
            DOM.alertTitle.textContent = cfg.titleText;
            DOM.alertTitle.className = `text-base font-display font-bold uppercase tracking-wide ${cfg.titleColor}`;
            DOM.severityBadge.textContent = cfg.badgeText;
            DOM.severityBadge.className = cfg.badgeClass;
            
            DOM.bridgeName.textContent = b.bridge.name;
            DOM.bridgeHeight.textContent = `${b.bridge.clearance}'`;
            DOM.youHeight.textContent = `${State.vehicleHeight.toFixed(1)}'`;
            
            const clearance = b.bridge.clearance - State.vehicleHeight;
            DOM.clearanceValue.textContent = `${clearance.toFixed(1)}'`;
            DOM.clearanceValue.className = `text-xl font-bold font-mono ${clearance < 0 ? 'text-red-500' : 'text-emerald-500'}`;
            DOM.youHighlight.style.display = clearance < 0 ? 'block' : 'none';
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // GPS & ORIENTATION HANDLERS
    // ─────────────────────────────────────────────────────────────────────────────
    const GPS = {
        onPosition(pos) {
            State.previousPosition = State.currentPosition;
            State.currentPosition = {
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
                speed: pos.coords.speed || 0,
                timestamp: Date.now()
            };
            
            // Update position history
            State.positionHistory.push({
                lat: State.currentPosition.latitude,
                lon: State.currentPosition.longitude,
                timestamp: State.currentPosition.timestamp
            });
            if (State.positionHistory.length > CONFIG.POSITION_HISTORY_SIZE) {
                State.positionHistory.shift();
            }
            
            // Calculate heading
            const speedMph = Geo.msToMph(pos.coords.speed);
            let newHeading = null;
            
            if (pos.coords.heading != null && speedMph >= CONFIG.MIN_SPEED_MPH) {
                newHeading = pos.coords.heading;
            } else if (State.previousPosition && speedMph >= CONFIG.MIN_SPEED_MPH) {
                newHeading = Geo.bearing(
                    State.previousPosition.latitude, State.previousPosition.longitude,
                    State.currentPosition.latitude, State.currentPosition.longitude
                );
            }
            
            if (newHeading !== null) {
                Heading.addSample(newHeading);
            }
            
            // Update display
            DOM.latValue.textContent = State.currentPosition.latitude.toFixed(6);
            DOM.lonValue.textContent = State.currentPosition.longitude.toFixed(6);
            
            // Throttled bridge check
            const now = Date.now();
            if (now - State.lastCheckTime >= CONFIG.CHECK_THROTTLE) {
                BridgeDetector.check();
                State.lastCheckTime = now;
            }
            
            Compass.update();
        },
        
        onOrientation(e) {
            let h = null;
            if (e.webkitCompassHeading !== undefined) h = e.webkitCompassHeading;
            else if (e.alpha !== null) h = (360 - e.alpha) % 360;
            
            if (h !== null) {
                State.deviceHeading = h;
                Compass.update();
            }
        },
        
        onError(e) {
            console.error('GPS Error:', e);
        },
        
        start() {
            if (!navigator.geolocation || State.inTestMode) return;
            
            State.watchId = navigator.geolocation.watchPosition(
                this.onPosition.bind(this),
                this.onError,
                { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
            );
            
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', this.onOrientation.bind(this));
            }
            
            State.isMonitoring = true;
        },
        
        stop() {
            if (State.watchId !== null) {
                navigator.geolocation.clearWatch(State.watchId);
                State.watchId = null;
            }
            window.removeEventListener('deviceorientation', this.onOrientation);
            State.isMonitoring = false;
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // UI CONTROLS
    // ─────────────────────────────────────────────────────────────────────────────
    const UI = {
        openEditModal() {
            DOM.editModal.classList.remove('hidden');
            DOM.editModal.classList.add('flex');
            DOM.heightInput.value = State.vehicleHeight;
        },
        
        closeEditModal() {
            DOM.editModal.classList.add('hidden');
            DOM.editModal.classList.remove('flex');
        },
        
        saveHeight() {
            State.vehicleHeight = parseFloat(DOM.heightInput.value);
            DOM.vehicleHeight.textContent = `${State.vehicleHeight.toFixed(1)} ft`;
            DOM.youHeight.textContent = `${State.vehicleHeight.toFixed(1)}'`;
            AlertPanel.update();
            this.closeEditModal();
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // TEST MODE
    // ─────────────────────────────────────────────────────────────────────────────
    const Test = {
        scenarios: [
            { height: 15.0, latOffset: -0.005, distance: 0.3 },  // Critical
            { height: 14.5, latOffset: -0.012, distance: 0.8 },  // Warning
            { height: 14.0, latOffset: -0.022, distance: 1.5 }   // Caution
        ],
        
        toggle() {
            if (!State.inTestMode) {
                State.inTestMode = true;
                State.testScenario = 0;
                DOM.testBtn.textContent = 'Next';
                DOM.testBtn.classList.add('bg-primary', 'text-background', 'border-primary');
                DOM.testBtn.classList.remove('border-white/20', 'hover:bg-white/5');
                this.run();
            } else {
                State.testScenario++;
                if (State.testScenario >= this.scenarios.length) {
                    this.exit();
                } else {
                    this.run();
                }
            }
        },
        
        run() {
            const scenario = this.scenarios[State.testScenario];
            const bridge = BRIDGES[0];
            
            // Setup test state
            State.currentHeading = 45;
            State.headingHistory = Array(5).fill(45);
            State.positionHistory = [
                { lat: bridge.lat - 0.006, lon: bridge.lon, timestamp: Date.now() - 2000 },
                { lat: bridge.lat - 0.0055, lon: bridge.lon, timestamp: Date.now() - 1000 },
                { lat: bridge.lat - 0.005, lon: bridge.lon, timestamp: Date.now() }
            ];
            
            State.vehicleHeight = scenario.height;
            State.currentPosition = {
                latitude: bridge.lat + scenario.latOffset,
                longitude: bridge.lon,
                speed: 13.41,
                timestamp: Date.now()
            };
            
            State.nearestBridge = {
                bridge: bridge,
                distance: scenario.distance,
                bearing: 45
            };
            
            // Update displays
            DOM.vehicleHeight.textContent = `${State.vehicleHeight.toFixed(1)} ft`;
            DOM.youHeight.textContent = `${State.vehicleHeight.toFixed(1)}'`;
            DOM.latValue.textContent = State.currentPosition.latitude.toFixed(6);
            DOM.lonValue.textContent = State.currentPosition.longitude.toFixed(6);
            
            Compass.update();
            AlertPanel.update();
        },
        
        exit() {
            State.inTestMode = false;
            State.testScenario = 0;
            
            DOM.testBtn.textContent = 'Test';
            DOM.testBtn.classList.remove('bg-primary', 'text-background', 'border-primary');
            DOM.testBtn.classList.add('border-white/20', 'hover:bg-white/5');
            
            // Reset state
            State.vehicleHeight = 15.0;
            State.nearestBridge = null;
            State.currentPosition = null;
            State.currentHeading = null;
            State.headingHistory = [];
            State.positionHistory = [];
            
            // Reset displays
            DOM.vehicleHeight.textContent = `${State.vehicleHeight.toFixed(1)} ft`;
            DOM.latValue.textContent = '---.------';
            DOM.lonValue.textContent = '---.------';
            DOM.bearingValue.textContent = '--';
            DOM.bearingDir.textContent = '--';
            DOM.distanceValue.textContent = '--';
            
            Compass.update();
            AlertPanel.update();
            GPS.start();
        }
    };

    // ─────────────────────────────────────────────────────────────────────────────
    // INITIALIZATION
    // ─────────────────────────────────────────────────────────────────────────────
    window.addEventListener('load', () => {
        // Cache DOM elements
        DOM_IDS.forEach(id => DOM[id] = document.getElementById(id));
        
        // Initialize components
        Compass.init();
        
        // Start GPS if not in test mode
        if (!State.inTestMode) {
            GPS.start();
        }
    });
    </script>
</body>
</html>
